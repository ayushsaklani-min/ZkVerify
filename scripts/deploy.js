/**
 * zkVerify â€” Moca Buildathon 2025 | Auditable Zero-Knowledge Verification Layer
 * 
 * Initial deployment script for ProofVerifier contract.
 * Requires existing AuditorRegistry address.
 */

const hre = require("hardhat");
const fs = require("fs");
const path = require("path");

async function main() {
  console.log("ğŸš€ Starting deployment to Moca Chain Testnet...");
  
  const auditorRegistryAddress = process.env.AUDITOR_REGISTRY_ADDRESS;
  if (!auditorRegistryAddress) {
    throw new Error("AUDITOR_REGISTRY_ADDRESS is required for deployment");
  }

  const trustedProver = process.env.TRUSTED_PROVER_ADDRESS || deployer.address;

  // Deploy verifier stack
  console.log("ğŸ“¦ Deploying ZKVerifier contract...");
  const ZKVerifier = await hre.ethers.getContractFactory("ZKVerifier");
  const zkVerifier = await ZKVerifier.deploy(trustedProver);
  await zkVerifier.waitForDeployment();
  const zkVerifierAddress = await zkVerifier.getAddress();
  console.log("âœ… ZKVerifier deployed at:", zkVerifierAddress);
  
  // Deploy the contract
  console.log("ğŸ“¦ Deploying ProofVerifier contract...");
  const ProofVerifier = await hre.ethers.getContractFactory("ProofVerifier");
  const contract = await ProofVerifier.deploy(auditorRegistryAddress, zkVerifierAddress);
  await contract.waitForDeployment();
  
  const address = await contract.getAddress();
  console.log("âœ… ProofVerifier deployed at:", address);
  
  // Get deployment info
  const [deployer] = await hre.ethers.getSigners();
  console.log("ğŸ‘¤ Deployer address:", deployer.address);
  console.log("ğŸ’° Deployer balance:", hre.ethers.formatEther(await hre.ethers.provider.getBalance(deployer.address)), "ETH");
  
  // Read ABI from artifacts
  const artifactPath = path.join(__dirname, "..", "artifacts", "contracts", "ProofVerifier.sol", "ProofVerifier.json");
  const artifact = JSON.parse(fs.readFileSync(artifactPath, "utf8"));
  const abi = artifact.abi;

  // Ensure frontend directories
  const frontendAbiPath = path.join(__dirname, "..", "frontend", "src", "abi", "ProofVerifier.json");
  const frontendConfigPath = path.join(__dirname, "..", "frontend", "src", "config.js");
  const frontendAbiDir = path.dirname(frontendAbiPath);
  const frontendConfigDir = path.dirname(frontendConfigPath);

  if (!fs.existsSync(frontendAbiDir)) fs.mkdirSync(frontendAbiDir, { recursive: true });
  if (!fs.existsSync(frontendConfigDir)) fs.mkdirSync(frontendConfigDir, { recursive: true });

  // Write ABI JSON for frontend consumers
  fs.writeFileSync(frontendAbiPath, JSON.stringify(abi, null, 2));

  const zkVerifierArtifact = JSON.parse(
    fs.readFileSync(path.join(__dirname, "..", "artifacts", "contracts", "ZKVerifier.sol", "ZKVerifier.json"), "utf8")
  );

  fs.writeFileSync(
    path.join(frontendAbiDir, "ZKVerifier.json"),
    JSON.stringify(zkVerifierArtifact.abi, null, 2)
  );

  // Create config for frontend (includes ABI export for convenience)
  const configContent = `// Auto-generated by deployment script
export const AUDITOR_REGISTRY_ADDRESS = "${auditorRegistryAddress}";
export const PROOF_VERIFIER_ADDRESS = "${address}";
export const ZK_VERIFIER_ADDRESS = "${zkVerifierAddress}";
export const CONTRACT_ADDRESS = "${address}";
export const CHAIN_ID = 5151;
export const RPC_URL = "https://testnet-rpc.mechain.tech";
export const EXPLORER_URL = "https://testnet-scan.mocachain.org";
export const DEPLOYER_ADDRESS = "${deployer.address}";
export const DEPLOYMENT_TIMESTAMP = ${Date.now()};
export { default as ProofVerifierABI } from '@/abi/ProofVerifier.json';
export { default as ZKVerifierABI } from '@/abi/ZKVerifier.json';
export { default as ABI } from '@/abi/ProofVerifier.json';
`;
  
  // Write config file
  fs.writeFileSync(frontendConfigPath, configContent);
  console.log("ğŸ“ Frontend config updated:", frontendConfigPath);
  console.log("ğŸ“ Frontend ABI updated:", frontendAbiPath);
  
  // Create deployment info file
  const deploymentInfo = {
    contractAddress: address,
    zkVerifier: zkVerifierAddress,
    trustedProver,
    deployerAddress: deployer.address,
    chainId: 5151,
    network: "moca-testnet",
    timestamp: new Date().toISOString(),
    blockNumber: await hre.ethers.provider.getBlockNumber(),
    gasUsed: "N/A", // Would need to track during deployment
  };
  
  fs.writeFileSync(
    path.join(__dirname, "..", "deployment-info.json"),
    JSON.stringify(deploymentInfo, null, 2)
  );
  
  console.log("ğŸ“Š Deployment info saved to deployment-info.json");
  console.log("ğŸ”— Contract on explorer:", `https://testnet-scan.mocachain.org/address/${address}`);
  
  console.log("\nğŸ‰ Deployment completed successfully!");
  console.log("ğŸ“‹ Summary:");
  console.log(`   Contract: ${address}`);
  console.log(`   Deployer: ${deployer.address}`);
  console.log(`   Network: Moca Chain Testnet (5151)`);
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error("âŒ Deployment failed:", error);
    process.exit(1);
  });
